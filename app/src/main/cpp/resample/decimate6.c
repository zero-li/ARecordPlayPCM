#include "decimate6.h"

#include <string.h>

static const float kDecimate6Taps[DECIMATE6_TAPS] = {
    2.988596105778e-05f, 6.171985885610e-05f, 9.387411113475e-05f, 1.095869039881e-04f,
    8.898893390409e-05f, 1.571670715310e-05f, -1.149107902397e-04f, -2.885726038117e-04f,
    -4.684358629961e-04f, -5.980834134565e-04f, -6.121933859307e-04f, -4.541413458873e-04f,
    -9.719162021572e-05f, 4.362175081648e-04f, 1.063642242589e-03f, 1.646136120330e-03f,
    2.009352761375e-03f, 1.981251662294e-03f, 1.440356313083e-03f, 3.639424248794e-04f,
    -1.137146198074e-03f, -2.809976586415e-03f, -4.286227878608e-03f, -5.145761036039e-03f,
    -5.009416444594e-03f, -3.644162457354e-03f, -1.056944477258e-03f, 2.448533781974e-03f,
    6.273961296789e-03f, 9.599379650025e-03f, 1.152420731064e-02f, 1.125714132161e-02f,
    8.321145324210e-03f, 2.730683813383e-03f, -4.902254211521e-03f, -1.336773673831e-02f,
    -2.097959050310e-02f, -2.581203004017e-02f, -2.601911073861e-02f, -2.018413516301e-02f,
    -7.634416578301e-03f, 1.134257561465e-02f, 3.543185036639e-02f, 6.239742938076e-02f,
    8.935613980843e-02f, 1.131797379696e-01f, 1.309602327155e-01f, 1.404587482112e-01f,
    1.404587482112e-01f, 1.309602327155e-01f, 1.131797379696e-01f, 8.935613980843e-02f,
    6.239742938076e-02f, 3.543185036639e-02f, 1.134257561465e-02f, -7.634416578301e-03f,
    -2.018413516301e-02f, -2.601911073861e-02f, -2.581203004017e-02f, -2.097959050310e-02f,
    -1.336773673831e-02f, -4.902254211521e-03f, 2.730683813383e-03f, 8.321145324210e-03f,
    1.125714132161e-02f, 1.152420731064e-02f, 9.599379650025e-03f, 6.273961296789e-03f,
    2.448533781974e-03f, -1.056944477258e-03f, -3.644162457354e-03f, -5.009416444594e-03f,
    -5.145761036039e-03f, -4.286227878608e-03f, -2.809976586415e-03f, -1.137146198074e-03f,
    3.639424248794e-04f, 1.440356313083e-03f, 1.981251662294e-03f, 2.009352761375e-03f,
    1.646136120330e-03f, 1.063642242589e-03f, 4.362175081648e-04f, -9.719162021572e-05f,
    -4.541413458873e-04f, -6.121933859307e-04f, -5.980834134565e-04f, -4.684358629961e-04f,
    -2.885726038117e-04f, -1.149107902397e-04f, 1.571670715310e-05f, 8.898893390409e-05f,
    1.095869039881e-04f, 9.387411113475e-05f, 6.171985885610e-05f, 2.988596105778e-05f
};

void decimate6_init(Decimate6State *state) {
    if (!state) {
        return;
    }
    decimate6_reset(state);
}

void decimate6_reset(Decimate6State *state) {
    if (!state) {
        return;
    }
    memset(state->history, 0, sizeof(state->history));
    state->index = 0;
    state->phase = 0;
}

size_t decimate6_process(Decimate6State *state, const float *input, size_t input_len, float *output) {
    if (!state || !input || !output) {
        return 0;
    }

    size_t produced = 0;
    for (size_t i = 0; i < input_len; ++i) {
        state->history[state->index] = input[i];
        state->index = (state->index + 1) % DECIMATE6_TAPS;
        state->phase = (state->phase + 1) % DECIMATE6_FACTOR;

        if (state->phase == 0) {
            float acc = 0.0f;
            size_t idx = state->index;
            for (size_t tap = 0; tap < DECIMATE6_TAPS; ++tap) {
                idx = (idx == 0) ? (DECIMATE6_TAPS - 1) : (idx - 1);
                acc += kDecimate6Taps[tap] * state->history[idx];
            }
            output[produced++] = acc;
        }
    }

    return produced;
}
